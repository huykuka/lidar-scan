<div class="flex flex-col h-full bg-neutral-100">
  <!-- Header -->
  <header class="bg-white border-b border-neutral-300 px-6 py-4">
    <div class="flex items-center gap-4">
      <syn-icon name="tune" class="text-3xl text-primary-600"></syn-icon>
      <div>
        <h1 class="text-xl font-semibold text-neutral-900 m-0">Calibration</h1>
        <p class="text-sm text-neutral-600 m-0">ICP-based LiDAR sensor alignment</p>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="flex-1 overflow-auto p-6">
    @if (calibrationNodes().length === 0) {
      <!-- Empty State -->
      <syn-card class="max-w-lg mx-auto mt-16">
        <div class="text-center p-8">
          <syn-icon name="tune" class="text-6xl text-neutral-400 mb-6"></syn-icon>
          <h2 class="text-lg text-neutral-700 mb-2 m-0">No Calibration Nodes</h2>
          <p class="text-neutral-600 mb-6 m-0">
            Create a calibration node in Settings to align multiple LiDAR sensors
          </p>
          <syn-button variant="filled" (click)="goToSettings()">
            <syn-icon slot="prefix" name="settings"></syn-icon>
            Go to Settings
          </syn-button>
        </div>
      </syn-card>
    } @else {
      <!-- Calibration Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        @for (node of calibrationNodes(); track node.id) {
          <syn-card class="flex flex-col">
            <!-- Card Header -->
            <div class="flex items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <syn-icon name="tune" class="text-2xl text-primary-600"></syn-icon>
                <div>
                  <h3 class="text-base font-semibold text-neutral-900 m-0">{{ node.name }}</h3>
                  <p class="text-xs font-mono text-neutral-600 m-0">{{ node.id.slice(0, 8) }}</p>
                </div>
              </div>
              <syn-badge [variant]="node.enabled ? 'success' : 'neutral'">
                {{ node.enabled ? 'Enabled' : 'Disabled' }}
              </syn-badge>
            </div>

            <syn-divider></syn-divider>

            <!-- Status Section -->
            <div class="mb-4">
              <h4 class="text-sm font-semibold text-neutral-700 mb-3 m-0">Status</h4>
              
              <div class="flex flex-col gap-2">
                <div class="flex justify-between items-center text-sm">
                  <span class="text-neutral-600">Buffered Sensors</span>
                  <span class="text-neutral-900 font-medium flex items-center gap-2">
                    {{ node.buffered_frames.length }}
                    @if (node.buffered_frames.length > 0) {
                      <syn-badge variant="primary" size="small">
                        {{ node.buffered_frames.length }}
                      </syn-badge>
                    }
                  </span>
                </div>

                @if (node.reference_sensor) {
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-neutral-600">Reference Sensor</span>
                    <span class="text-xs font-mono text-neutral-900">
                      {{ node.reference_sensor.slice(0, 8) }}
                    </span>
                  </div>
                }

                @if (node.source_sensors.length > 0) {
                  <div class="flex justify-between items-start text-sm">
                    <span class="text-neutral-600">Source Sensors</span>
                    <div class="flex flex-col items-end gap-1">
                      @for (sensor of node.source_sensors; track sensor) {
                        <span class="text-xs font-mono text-neutral-900">
                          {{ sensor.slice(0, 8) }}
                        </span>
                      }
                    </div>
                  </div>
                }

                @if (node.last_calibration_time) {
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-neutral-600">Last Calibration</span>
                    <span class="text-neutral-900 font-medium">
                      {{ formatTime(node.last_calibration_time) }}
                    </span>
                  </div>
                }
              </div>
            </div>

            <!-- Pending Results Section -->
            @if (node.has_pending && hasPendingResults(node)) {
              <syn-divider></syn-divider>
              
              <div class="mb-4">
                <h4 class="text-sm font-semibold text-neutral-700 mb-3 m-0 flex items-center gap-2">
                  <syn-icon name="check_circle" class="text-success-600"></syn-icon>
                  Pending Results
                </h4>

                <div class="flex flex-col gap-2">
                  @for (result of getPendingResultsList(node); track result.sensorId) {
                    <div class="bg-neutral-50 border border-neutral-200 rounded-lg p-3">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-mono font-medium text-neutral-900">
                          {{ result.sensorId.slice(0, 8) }}
                        </span>
                        <syn-badge [variant]="getQualityVariant(result.quality)">
                          {{ result.quality }}
                        </syn-badge>
                      </div>
                      <div class="grid grid-cols-2 gap-2">
                        <div class="flex flex-col gap-0.5">
                          <span class="text-xs text-neutral-600">Fitness</span>
                          <span class="text-sm font-semibold text-neutral-900">
                            {{ (result.fitness * 100).toFixed(1) }}%
                          </span>
                        </div>
                        <div class="flex flex-col gap-0.5">
                          <span class="text-xs text-neutral-600">RMSE</span>
                          <span class="text-sm font-semibold text-neutral-900">
                            {{ result.rmse.toFixed(4) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Actions -->
            <div class="flex justify-end gap-2 mt-auto">
              @if (node.has_pending && hasPendingResults(node)) {
                <syn-button variant="text" size="small" (click)="viewDetails(node.id)">
                  <syn-icon slot="prefix" name="visibility"></syn-icon>
                  View Details
                </syn-button>
              } @else {
                <syn-button variant="text" size="small" (click)="viewHistory(node.id)">
                  <syn-icon slot="prefix" name="history"></syn-icon>
                  View History
                </syn-button>
              }
            </div>
          </syn-card>
        }
      </div>
    }
  </div>
</div>
