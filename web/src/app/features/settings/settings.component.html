<div class="flex flex-col gap-8 animate-in fade-in duration-500">
  
  <!-- Toolbox Header -->
  <app-toolbox-header
    [isExporting]="isExporting()"
    [isImporting]="isImporting()"
    (exportConfig)="onExportConfig()"
    (importConfig)="onImportConfigClick()"
    (reloadConfig)="onReloadConfig()"
    (addLidar)="onAddLidar()"
    (addFusion)="onAddFusion()"
    (dragStart)="onDragStart($event.event, $event.type)"
  />

  <div class="relative rounded-2xl transition-all duration-300 h-full w-full min-h-[300px]" 
       (dragover)="onDragOver($event)">
       
    <!-- Centered Drop Zone Indicator (Intercepts events so no flickering) -->
    <div *ngIf="isDraggingOver" 
         class="absolute inset-x-0 inset-y-0 -m-1 z-50 flex items-center justify-center bg-syn-color-neutral-50/70 backdrop-blur-sm rounded-2xl border-4 border-dashed border-syn-color-primary-500 animate-in fade-in zoom-in-95 duration-200"
         (dragover)="onDragOver($event)" 
         (dragleave)="onDragLeave($event)" 
         (drop)="onDrop($event)">
         
      <div class="flex flex-col items-center justify-center gap-4 bg-white px-10 py-8 rounded-3xl shadow-2xl pointer-events-none scale-110">
        <syn-icon name="add_circle" class="text-5xl text-syn-color-primary-600 animate-bounce"></syn-icon>
        <h3 class="text-lg font-black text-syn-color-primary-800 uppercase tracking-widest">Drop to Add Node</h3>
      </div>
    </div>

    <div class="transition-opacity duration-300" [class.opacity-40]="isDraggingOver">
      <syn-accordion contained size="small" class="block">
        <syn-details [open]="lidars().length > 0" [disabled]="lidars().length === 0" contained size="small">
          <div slot="summary" class="w-full flex items-center justify-between gap-3 pr-2">
            <div class="flex items-center gap-2 min-w-0">
              <syn-icon name="sensors" class="text-base text-syn-color-success-600"></syn-icon>
              <span class="text-[11px] font-black uppercase tracking-widest text-syn-color-neutral-600 truncate">Sensors</span>
              <span class="text-[11px] text-syn-color-neutral-400 truncate">(hardware / sim)</span>
            </div>
            <syn-badge variant="success" pill size="small">{{ lidars().length }}</syn-badge>
          </div>

          <div class="pt-3">
            <div *ngIf="lidars().length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              @for (lidar of lidars(); track lidar.id) {
                <app-lidar-card
                  [lidar]="lidar"
                  [isLoading]="isLidarLoading(lidar.id || '')"
                  [nodeStatus]="getNodeStatus(lidar.id || '') ?? null"
                  (toggleEnabled)="onToggleLidarEnabled($event.lidar, $event.enabled)"
                  (edit)="onEditLidar($event)"
                  (delete)="onDeleteLidar($event)"
                />
              }
            </div>

            <div *ngIf="lidars().length === 0" class="text-sm text-syn-color-neutral-500 italic">
              No sensors registered.
            </div>
          </div>
        </syn-details>

        <syn-details [open]="lidars().length === 0 && fusions().length > 0" [disabled]="fusions().length === 0" contained size="small">
          <div slot="summary" class="w-full flex items-center justify-between gap-3 pr-2">
            <div class="flex items-center gap-2 min-w-0">
              <syn-icon name="hub" class="text-base text-syn-color-primary-600"></syn-icon>
              <span class="text-[11px] font-black uppercase tracking-widest text-syn-color-neutral-600 truncate">Fusions</span>
              <span class="text-[11px] text-syn-color-neutral-400 truncate">(merged topics)</span>
            </div>
            <syn-badge variant="primary" pill size="small">{{ fusions().length }}</syn-badge>
          </div>

          <div class="pt-3">
            <div *ngIf="fusions().length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              @for (fusion of fusions(); track fusion.id) {
                <app-fusion-card
                  [fusion]="fusion"
                  [isLoading]="isFusionLoading(fusion.id || '')"
                  [nodeStatus]="getFusionStatus(fusion.id || '') ?? null"
                  [sensorsLabel]="fusionSensorsLabel(fusion.sensor_ids)"
                  (toggleEnabled)="onToggleFusionEnabled($event.fusion, $event.enabled)"
                  (edit)="onEditFusion($event)"
                  (delete)="onDeleteFusion($event)"
                />
              }
            </div>

            <div *ngIf="fusions().length === 0" class="text-sm text-syn-color-neutral-500 italic">
              No fusions registered.
            </div>
          </div>
        </syn-details>
      </syn-accordion>

      <!-- Empty State if no nodes at all -->
      <div *ngIf="lidars().length === 0 && fusions().length === 0 && !isLoading()" 
           class="flex flex-col items-center justify-center p-12 bg-syn-color-neutral-50/50 rounded-2xl border-2 border-dashed border-syn-color-neutral-200 text-syn-color-neutral-400">
        <div class="p-4 bg-white rounded-full shadow-sm mb-4 border border-syn-color-neutral-100">
          <syn-icon name="widgets" class="text-4xl text-syn-color-primary-300"></syn-icon>
        </div>
        <p class="font-black uppercase tracking-widest text-sm text-syn-typography-color-text">No active nodes in network</p>
        <p class="text-sm mt-2 font-medium">Click on a component in the toolbox to get started.</p>
      </div>
    </div>
  </div>

  <!-- Configuration Import Validation Dialog -->
  <app-config-import-dialog
    [open]="showValidationDialog()"
    [validationResult]="validationResult()"
    [isImporting]="isImporting()"
    [(mergeMode)]="importMergeMode"
    (cancel)="onCancelImport()"
    (confirm)="onConfirmImport()"
    (requestClose)="onCancelImport()"
  />
</div>
