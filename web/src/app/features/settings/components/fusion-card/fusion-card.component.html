<div class="relative">
  <!-- Loading Overlay -->
  @if (isLoading()) {
    <div class="absolute inset-0 z-10 bg-white/80 backdrop-blur-sm rounded-xl flex items-center justify-center">
      <syn-spinner></syn-spinner>
    </div>
  }
  
  <div class="bg-white rounded-xl shadow-sm border border-syn-color-neutral-200 flex flex-col justify-between hover:border-syn-color-primary-300 hover:shadow-md transition-all group overflow-hidden" [class.opacity-60]="fusion().enabled === false">
    <div class="h-1 w-full bg-syn-color-primary-500"></div>

    <div class="p-3">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 min-w-0">
          <div class="p-1.5 rounded-md bg-syn-color-neutral-100 text-syn-color-primary-700">
            <syn-icon name="hub" class="text-base"></syn-icon>
          </div>
          <span class="font-black text-syn-typography-color-text text-sm truncate" [title]="fusion().name">{{ fusion().name }}</span>
        </div>
        <div class="flex items-center gap-2">
          <syn-badge [variant]="(fusion().enabled ?? true) ? 'primary' : 'neutral'" pill size="small">{{ (fusion().enabled ?? true) ? 'Fusion' : 'Disabled' }}</syn-badge>
          <syn-switch
            size="small"
            [checked]="fusion().enabled ?? true"
            (syn-change)="toggleEnabled.emit({ fusion: fusion(), enabled: $any($event.target).checked }); $event.stopPropagation()"
          >
            {{ (fusion().enabled ?? true) ? 'Enabled' : 'Disabled' }}
          </syn-switch>
        </div>
      </div>

      <div class="mt-2 text-[11px] text-syn-color-neutral-600 font-mono truncate" [title]="fusion().topic">{{ fusion().topic }}</div>

      <div class="mt-2 flex items-center gap-2 flex-wrap">
        <syn-badge variant="neutral" pill size="small">{{ fusion().pipeline_name || 'No pipeline' }}</syn-badge>
        <syn-badge variant="neutral" pill size="small" [title]="sensorsLabel()">{{ fusion().sensor_ids && fusion().sensor_ids.length ? (fusion().sensor_ids.length + ' sensors') : 'All sensors' }}</syn-badge>
        <syn-badge
          [variant]="fusion().enabled === false ? 'neutral' : 'primary'"
          pill
          size="small"
        >
          {{ fusion().enabled === false ? 'Disabled' : 'Enabled' }}
        </syn-badge>
        
        <!-- Runtime Status -->
        @if (nodeStatus(); as status) {
          @if (status.last_error) {
            <div class="flex items-center justify-center" style="color: var(--syn-color-danger-600); font-size: var(--syn-font-size-x-large);" [title]="'Error: ' + status.last_error">
              <syn-icon name="error"></syn-icon>
            </div>
          } @else if (status.running) {
            @if (status.broadcast_age_seconds !== null && status.broadcast_age_seconds < 5) {
              <div class="flex items-center justify-center" style="color: var(--syn-color-success-600); font-size: var(--syn-font-size-x-large);" title="Running">
                <syn-icon name="check_circle"></syn-icon>
              </div>
            } @else if (status.broadcast_age_seconds !== null && status.broadcast_age_seconds >= 5) {
              <div class="flex items-center justify-center" style="color: var(--syn-color-warning-600); font-size: var(--syn-font-size-x-large);" [title]="'Stale: Last broadcast ' + status.broadcast_age_seconds.toFixed(1) + 's ago'">
                <syn-icon name="schedule"></syn-icon>
              </div>
            } @else {
              <div class="flex items-center justify-center" style="color: var(--syn-color-warning-600); font-size: var(--syn-font-size-x-large);" title="Starting">
                <syn-icon name="pending"></syn-icon>
              </div>
            }
          } @else if (status.enabled) {
            <div class="flex items-center justify-center" style="color: var(--syn-color-neutral-500); font-size: var(--syn-font-size-x-large);" title="Stopped">
              <syn-icon name="stop_circle"></syn-icon>
            </div>
          }
        }
      </div>
    </div>

    <div class="flex justify-end px-3 py-2 bg-syn-color-neutral-50 border-t border-syn-color-neutral-100 gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
      <syn-button variant="outline" size="small" (click)="edit.emit(fusion())">Edit</syn-button>
      <syn-button variant="outline" color="danger" size="small" (click)="delete.emit(fusion().id!)">Delete</syn-button>
    </div>
  </div>
</div>
