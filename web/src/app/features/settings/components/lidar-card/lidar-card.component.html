<div class="relative">
  <!-- Loading Overlay -->
  @if (isLoading()) {
    <div class="absolute inset-0 z-10 bg-white/80 backdrop-blur-sm rounded-xl flex items-center justify-center">
      <syn-spinner></syn-spinner>
    </div>
  }
  
  <div class="bg-white rounded-xl shadow-sm border border-syn-color-neutral-200 flex flex-col justify-between hover:border-syn-color-primary-300 hover:shadow-md transition-all group overflow-hidden" [class.opacity-60]="lidar().enabled === false">
    <div class="h-1 w-full" [ngClass]="lidar().mode === 'sim' ? 'bg-syn-color-neutral-300' : 'bg-syn-color-success-500'"></div>

    <div class="p-3">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 min-w-0">
          <div class="p-1.5 rounded-md bg-syn-color-neutral-100 text-syn-color-success-700">
            <syn-icon name="sensors" class="text-base"></syn-icon>
          </div>
          <span class="font-black text-syn-typography-color-text text-sm truncate" [title]="lidar().name">{{ lidar().name }}</span>
        </div>
        <div class="flex items-center gap-2">
          <syn-badge [variant]="(lidar().enabled ?? true) ? (lidar().mode === 'sim' ? 'neutral' : 'success') : 'neutral'" pill size="small">{{ (lidar().enabled ?? true) ? 'Sensor' : 'Disabled' }}</syn-badge>
          <syn-switch
            size="small"
            [checked]="lidar().enabled ?? true"
            (syn-change)="toggleEnabled.emit({ lidar: lidar(), enabled: $any($event.target).checked }); $event.stopPropagation()"
          >
            {{ (lidar().enabled ?? true) ? 'Enabled' : 'Disabled' }}
          </syn-switch>
        </div>
      </div>

      <div class="mt-2 text-[11px] text-syn-color-neutral-600 font-mono truncate" [title]="getTopic()">
        {{ getTopic() }}
      </div>

      <div class="mt-2 flex items-center gap-2 flex-wrap">
        <syn-badge variant="neutral" pill size="small">{{ lidar().pipeline_name || 'No pipeline' }}</syn-badge>
        <syn-badge [variant]="lidar().mode === 'sim' ? 'neutral' : 'success'" pill size="small">{{ lidar().mode === 'sim' ? 'Sim' : 'HW' }}</syn-badge>
        <syn-badge
          [variant]="lidar().enabled === false ? 'neutral' : 'success'"
          pill
          size="small"
        >
          {{ lidar().enabled === false ? 'Disabled' : 'Enabled' }}
        </syn-badge>
        
        <!-- Runtime Status -->
        @if (nodeStatus(); as status) {
          @if (status.last_error) {
            <div class="flex items-center justify-center" style="color: var(--syn-color-danger-600); font-size: var(--syn-font-size-x-large);" [title]="'Error: ' + status.last_error">
              <syn-icon name="error"></syn-icon>
            </div>
          } @else if (status.running) {
            @if (status.frame_age_seconds !== null && status.frame_age_seconds < 5) {
              <div class="flex items-center justify-center" style="color: var(--syn-color-success-600); font-size: var(--syn-font-size-x-large);" title="Running">
                <syn-icon name="check_circle"></syn-icon>
              </div>
            } @else if (status.frame_age_seconds !== null && status.frame_age_seconds >= 5) {
              <div class="flex items-center justify-center" style="color: var(--syn-color-warning-600); font-size: var(--syn-font-size-x-large);" [title]="'Stale: Last frame ' + status.frame_age_seconds.toFixed(1) + 's ago'">
                <syn-icon name="schedule"></syn-icon>
              </div>
            } @else {
              <div class="flex items-center justify-center" style="color: var(--syn-color-warning-600); font-size: var(--syn-font-size-x-large);" title="Starting">
                <syn-icon name="pending"></syn-icon>
              </div>
            }
          } @else if (status.enabled) {
            <div class="flex items-center justify-center" style="color: var(--syn-color-neutral-500); font-size: var(--syn-font-size-x-large);" title="Stopped">
              <syn-icon name="stop_circle"></syn-icon>
            </div>
          }
        }
      </div>
    </div>

    <div class="flex justify-end px-3 py-2 bg-syn-color-neutral-50 border-t border-syn-color-neutral-100 gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
      <syn-button variant="outline" size="small" (click)="edit.emit(lidar())">Edit</syn-button>
      <syn-button variant="outline" color="danger" size="small" (click)="delete.emit(lidar().id!)">Delete</syn-button>
    </div>
  </div>
</div>
