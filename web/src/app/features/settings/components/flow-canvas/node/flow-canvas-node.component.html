<div
  class="bg-white rounded-lg shadow-lg border-2 w-72 hover:shadow-xl transition-all relative"
  [class.border-syn-color-success-400]="node().type === 'sensor'"
  [class.border-syn-color-primary-400]="node().type === 'fusion'"
  [class.border-syn-color-warning-400]="node().type === 'operation'"
  [class.opacity-50]="isDragging()"
>
  <!-- Input Port (left side — rendered if node definition has inputs) -->
  @if (hasInputPort()) {
    <div
      class="absolute left-0 top-[44px] transform -translate-x-full -translate-y-1/2 w-4 h-6 rounded-sm border-2 border-white z-10 cursor-crosshair transition-transform after:absolute after:-inset-4 after:content-[''] bg-[#066fff]"
      title="Input port — drop connection here"
      (mousedown)="$event.stopPropagation()"
      (mouseup)="$event.stopPropagation(); portDrop.emit({ nodeId: node().id, portType: 'input' })"
    ></div>
  }

  <!-- Output Port (right side — rendered if node definition has outputs) -->
  @if (hasOutputPort()) {
    <div
      class="absolute right-0 top-[44px] transform translate-x-full -translate-y-1/2 w-4 h-6 rounded-sm border-2 border-white z-10 cursor-crosshair h transition-transform after:absolute after:-inset-4 after:content-[''] bg-[#066fff]"
      title="Output port — drag to connect"
      (mousedown)="
        $event.stopPropagation();
        portDragStart.emit({ nodeId: node().id, portType: 'output', event: $event })
      "
      (mouseup)="$event.stopPropagation()"
    ></div>
  }

  <!-- Node Header -->
  <div class="p-3 flex items-center rounded-t-[6px]">
    <div class="flex items-center gap-2 min-w-0 flex-1">
      <syn-icon
        [name]="getNodeIcon()"
        class="text-xl shrink-0"
        [class.text-syn-color-success-600]="node().type === 'sensor'"
        [class.text-syn-color-primary-600]="node().type === 'fusion'"
        [class.text-syn-color-warning-600]="node().type === 'operation'"
      ></syn-icon>
      <div class="flex flex-row min-w-0 items-center" [title]="statusBadge().label">
        <span class="font-semibold text-sm truncate flex-1">{{ getNodeName() }} </span>
        <syn-badge [variant]="statusBadge().variant" size="small" pill class="ml-2"> </syn-badge>
      </div>
    </div>
    <syn-button
      variant="text"
      size="small"
      class="ml-2 shrink-0 flex items-center"
      (click)="isExpanded.set(!isExpanded())"
    >
      <syn-icon
        [name]="isExpanded() ? 'expand_less' : 'expand_more'"
        class="text-syn-color-neutral-600 transition-transform"
      ></syn-icon>
    </syn-button>
  </div>

  <!-- Node Body (Collapsible Details) -->
  @if (isExpanded()) {
    <div class="p-3 space-y-2 text-xs">
      <!-- Render Dynamic Config Properties -->
      <div class="flex flex-col gap-y-1.5 py-1">
        @for (param of getConfigProperties(); track param.label) {
          <div class="flex justify-between items-center w-full gap-2">
            <span
              class="text-[10px] text-syn-color-neutral-500 uppercase tracking-tighter shrink-0"
              >{{ param.label }}</span
            >

            <!-- Value or badge rendering -->
            @if (param.isBadge) {
              <syn-badge [variant]="param.badgeVariant || 'neutral'" size="small" class="shrink-0">
                {{ param.value }}
              </syn-badge>
            } @else {
              <span
                class="font-mono text-[11px] truncate text-right flex-1 min-w-0"
                [title]="param.value"
                >{{ param.value }}</span
              >
            }
          </div>
        }
      </div>

      <!-- Runtime Frame Age status -->
      @if (status() && getFrameAge()) {
        <div class="flex flex-col pt-2 border-t border-syn-color-neutral-100">
          <span class="text-[10px] text-syn-color-neutral-400 uppercase tracking-tighter mb-0.5"
            >Last Frame Update</span
          >
          <span
            class="font-mono text-[11px] font-semibold"
            [class.text-syn-color-success-600]="!isFrameStale() && !isFrameVeryStale()"
            [class.text-syn-color-warning-600]="isFrameStale() && !isFrameVeryStale()"
            [class.text-syn-color-danger-600]="isFrameVeryStale()"
          >
            {{ getFrameAge() }} ago
          </span>
        </div>
      }

      @if (status()?.last_error) {
        <div
          class="text-syn-color-danger-600 text-[11px] mt-2 p-2 bg-syn-color-danger-50 rounded border border-syn-color-danger-200 break-words"
        >
          {{ status()?.last_error }}
        </div>
      }
    </div>
  }

  <!-- Node Actions -->
  <div class="p-2 border-t border-syn-color-neutral-200 flex items-center gap-1">
    <div class="flex items-center gap-2 flex-1 min-w-0">
      <syn-switch
        size="small"
        [checked]="isNodeEnabled()"
        [disabled]="isLoading()"
        (syn-change)="onToggleEnabled.emit($any($event.target).checked)"
        class="shrink-0"
      ></syn-switch>
      @if (isLoading()) {
        <syn-spinner size="small"></syn-spinner>
      } @else {
        <span
          class="text-xs font-semibold truncate transition-colors"
          [class.text-syn-color-success-700]="isNodeEnabled()"
          [class.text-syn-color-danger-600]="!isNodeEnabled()"
        >
          {{ isNodeEnabled() ? 'Enabled' : 'Disabled' }}
        </span>
      }
    </div>

    <!-- Calibration Button (only for calibration nodes) -->
    @if (isNodeEnabled() && isCalibrationNode()) {
      @if (hasPendingCalibration()) {
        <!-- Pending Calibration - Accept/Reject Buttons -->
        <div class="flex gap-1">
          <syn-button
            variant="filled"
            color="success"
            size="small"
            (click)="acceptCalibration(); $event.stopPropagation()"
            [disabled]="isCalibrating()"
            title="Accept & Save Calibration"
          >
            <syn-icon name="check"></syn-icon>
          </syn-button>
          <syn-button
            variant="outline"
            color="danger"
            size="small"
            (click)="rejectCalibration(); $event.stopPropagation()"
            [disabled]="isCalibrating()"
            title="Reject Calibration"
          >
            <syn-icon name="close"></syn-icon>
          </syn-button>
        </div>
      } @else {
        <!-- Trigger Calibration Button -->
        <syn-button
          variant="filled"
          color="primary"
          size="small"
          (click)="triggerCalibration(); $event.stopPropagation()"
          [disabled]="isCalibrating()"
          title="Run Calibration"
        >
          @if (isCalibrating()) {
            <syn-spinner size="small"></syn-spinner>
          } @else {
            <syn-icon name="tune"></syn-icon>
          }
        </syn-button>
      }
    }

    <!-- Recording Button (only shown for nodes with outputs) -->
    @if (isNodeEnabled() && hasOutputPort()) {
      @if (isRecording()) {
        <syn-button
          variant="filled"
          color="danger"
          size="small"
          (click)="toggleRecording(); $event.stopPropagation()"
        >
          <syn-icon slot="prefix" name="stop" class="animate-pulse"></syn-icon>
          <span class="text-xs">{{ formatDuration(recordingDuration()) }}</span>
        </syn-button>
      } @else {
        <syn-button
          variant="text"
          size="small"
          (click)="toggleRecording(); $event.stopPropagation()"
          title="Start Recording"
        >
          <syn-icon name="fiber_manual_record" style="color: var(--syn-color-error-700)"></syn-icon>
        </syn-button>
      }
    }

    <syn-button variant="text" size="small" (click)="onDelete.emit(); $event.stopPropagation()">
      <syn-icon name="delete" style="color: var(--syn-color-error-700)"></syn-icon>
    </syn-button>
  </div>
</div>
